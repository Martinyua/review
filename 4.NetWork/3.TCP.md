### 传输层协议的作用

- 提供了一种**端到端**的连接
- 由于网络层只管传递数据，并不关心成功与否，TCP协议在数据丢失、损坏的情况下保证**数据的可靠性**

### 传输层协议的分类

- **传输控制协议TCP**
  1. 可靠的，面向连接的协议
  2. 传输效率低
- **用户协议数据报UDP**
  1. 不可靠、无连接的协议
  2. 传输效率高

### TCP的功能

为了保证TCP是可靠的、面向连接的协议，具备以下功能：

1. 将数据进行分段**打包传输**，如果不将数据分段打包传输，那么会导致每次传输的数据特别大，而带宽是一定的，所以很容易造成拥塞。想象一下，一辆火车跑在公路上的感觉。
2. 对每个数据包**编号控制顺序**，因为数据进行了分段打包传输，而网络中的路线不止一条，而且某些路线会有延迟的情况，没有编号，那么如何保证到达的数据是原来的模样。想象一下，将一副大拼图从一个地方，分多条路运往另外一个地方，并且没有编号。
3. **运输中丢失、重发和丢弃处理**，由于网络中的路线会有延迟，并且存在丢包现象，所以会有**重发等机制**来保证数据的完整性。
4. **流量控制避免拥塞**，避免发送速率过快，让接收方来不及接收，导致发生丢包。





### 三次握手和四次挥手

#### 三次握手

1. 序号：seq。
2. 确认序号：ack序号
3. 标志位：SYN，ACK

* 第一次，客户端向服务端发送连接请求报文段。该报文段的头部中`SYN=1，seq=x`。请求发送后，客户端便进入SYN-SENT状态。
* 第二次。服务端收到连接请求报文段后，如果同意连接，则会发送一个应答：`SYN=1，ACK=1，seq=y，ack=x+1`。该应答发送完成后便进入SYN-RCVD状态。
* 第三次，客户端收到服务端的回复。于是知道服务端已经收到了序列号为x的那段报文，知道了服务端同意了这次连接。发送一个标志位`ACK=1，seq=x+1，ack=y+1`



**三次握手：**



1. 第一次握手主机A通过一个**标识为`SYN标识位`**的数据段发送给**主机B请 求连接**，通过该数据段告诉主机B**希望建立连接**，需要B应答，并告诉主机B传输的**起始序列号**
2. 第二次握手是主机B用一个**确认应答ACK**和**同步序列号SYN**标志位的数据段来响应主机A，一是发送ACK告诉主机A收到了数据段，二是通知主机A从哪个序列号做标记。（客户端发送`syn`，跟服务器说“我要连接啦”，进入`syn_send`状态。
   服务端接收然后发送`syn` + `ack`包给客户端，跟客户端说“我知道了，我这边ok了”，进入`syn_recv`状态。）
3. 客户端接收后发一个ack，跟服务端说”我要连接咯！“，进入establish状态，连接成功。

第一次握手主要是确定服务端确认客户端能够发送信号；第二次握手主要是客户端确认服务端能够接收和发送信号；第三次握手主要是服务端确认客户端能够接收信号



**四次挥手：**

因为 TCP 连接是全双工的，也就是说通信的双方都可以向对方发送和接收消息，所以断开连接需要双方的确认。

1. 第一次挥手，客户端认为没有数据要再发送给服务器端，它就向服务器发送一个 FIN 报文段，申请断开客户端到服务器端的 连接。发送后客户端进入 FIN_WAIT_1 状态。

2. 第二次挥手，服务器端接收到客户端释放连接的请求后，向客户端发送一个确认报文段，表示已经接收到了客户端释放连接的 请求，以后不再接收客户端发送过来的数据。但是因为连接是全双工的，所以此时，服务器端还可以向客户端发送数据。服务 器端进入 CLOSE_WAIT 状态。客户端收到确认后，进入 FIN_WAIT_2 状态。

3. 第三次挥手，服务器端发送完所有数据后，向客户端发送 FIN 报文段，申请断开服务器端到客户端的连接。发送后进入 LAS T_ACK 状态。

4. 第四次挥手，客户端接收到 FIN 请求后，向服务器端发送一个确认应答，并进入 TIME_WAIT 阶段。该阶段会持续一段时间， 这个时间为报文段在网络中的最大生存时间，如果该时间内服务端没有重发请求的话，客户端进入 CLOSED 的状态。如果收到 服务器的重发请求就重新发送确认报文段。服务器端收到客户端的确认报文段后就进入 CLOSED 状态，这样全双工的连接就被 释放了。

TCP 使用四次挥手的原因是因为 TCP 的连接是全双工的，**所以需要双方分别释放到对方的连接**，单独一方的连接释放，只代 表不能再向对方发送数据，连接处于的是半释放的状态。

**等待2msl**：最后一次挥手中，**客户端会等待一段时间再关闭的原因**，是为了防止**发送给服务器的确认报文段丢失或者出错，从而导致服务器 端不能正常关闭。**

第一次挥手是**服务端确认客户端需要断开连接**；第二次挥手是**客户端确认服务器接收断开请**；第三次挥手是**客户端确认服务器数据发完**，断开连接；第四次挥手是**服务端确认客户端断开连接**，断开连接。所以如果服务端的数据全部发送完，是没有第三次挥手，直接进入第四次挥手。

### 拥塞控制和流量控制

拥塞控制和流量控制的差别：

- 拥塞问题是一个**全局性的问题**,涉及到所有的主机、所有的路由器、以及与降低网络传输性能有关的所有因素。流量控制往往指的是**点对点通信量的控制**，是个端到端的问题。
- 流量控制所要做的就是控制**发送端发送数据的速率**，以便使接收端来得及接受。拥塞控制控制的是**注入网络中的数据量**。
- 流量窗口是接收方控制的，拥塞窗口是发送方控制的

#### TCP流量控制

所谓的流量控制就是接收方让发送方的发送速率不要太快，让接收方来得及接受。利用**滑动窗口机制**可以很方便的在TCP连接上实现对发送方的流量控制。

#### TCP拥塞控制

* **拥塞控制原理：**

  只要网络没有出现拥塞，拥塞窗口就增大一些，以便把更多的分组发送出去。但是只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络的分组数。

* **拥塞控制方法:**

  因特网建议标准RFC2581定义了进行拥塞控制的四种算法，即`慢开始（Slow-start)`、`拥塞避免（Congestion Avoidance)`、`快重传（Fast Restrangsmit)`和`快恢复（Fast Recovery）`。我们假定：

* **慢开始和拥塞避免轮回机制：**

  拥塞窗口`cwnd`：发送端缓冲区大小

  为了防止`cwnd`增长过大引起网络拥塞，还需设置一个慢开始门限`ssthresh`状态变量。**`ssthresh`**的用法如下：

  - 当`cwnd`<`ssthresh`时，使用**慢开始算法。**

  - 当`cwnd`>`ssthresh`时，改用**拥塞避免算法**。

  - 当`cwnd`=`ssthresh`时，慢开始与拥塞避免算法任意。

  - 乘法减小：是指不论在慢开始阶段还是拥塞避免阶段，只要出现超时，就把慢开始门限减半，即设置为当前的拥塞窗口的一半（于此同时，执行慢开始算法）。当网络出现频繁拥塞时，`ssthresh`值就下降的很快，以大大减小注入到网络中的分组数。

    加法增大：是指执行拥塞避免算法后是拥塞窗口缓慢增大，以防止网络过早出现拥塞。

    

![乘法减小和加法增大](https://user-gold-cdn.xitu.io/2018/9/21/165fadfdd636ce26?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



**快重传**

**快重传**算法规定，发送方只要**一连收到三个重复确认**就应当**立即重传对方尚未收到的报文段，而不必继续等待设置的重传计时器时间到期。**如下图：

![快重传](https://user-gold-cdn.xitu.io/2018/9/21/165fae388ca291d1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

**快恢复**

1. 当发送方收到三个 重复确认时，就执行“乘法减小”算法，把`ssthresh`门限减半。但是接下去并**不执行慢开始算法**。
2. 考虑到如果网络出现拥塞的话就不会收到好几个重复的确认，所以认为可能没有拥塞，所以不执行慢开始算法，而是将`cwnd`设置为`ssthresh`减半后的大小，然后执行拥塞避免算法。如下图：

![快恢复](https://user-gold-cdn.xitu.io/2018/9/21/165fae5de0c9f30a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



### TCP协议是如何保证可靠传输的

1. 应用数据被分割成 TCP 认为最适合发送的**数据块**。
2. TCP 给发送的每一个包进行**编号**，接收方对数据包进行**排序**，把有序数据传送给应用层。
3. **校验和：**TCP 将保持它首部和数据的检验和。这是一个端到端的检验和，目的是检测数据在传输过程中的任何变化。如果收到段的检验和有差错，TCP 将丢弃这个报文段和不确认收到此报文段。
4. TCP 的接收端会丢弃重复的数据。
5. **流量控制：**TCP 连接的每一方都有固定大小的缓冲空间，TCP的接收端只允许发送端发送接收端缓冲区能接纳的数据。当接收方来不及处理发送方的数据，能提示发送方降低发送的速率，防止包丢失。TCP 使用的流量控制协议是可变大小的滑动窗口协议。 （TCP 利用滑动窗口实现流量控制）
6. **拥塞控制：**当网络拥塞时，减少数据的发送。
7. **ARQ协议：**也是为了实现可靠传输的，它的基本原理就是每发完一个分组就停止发送，等待对方确认。在收到确认后再发下一个分组。
8. **超时重传：**当 TCP 发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段。

### UDP应用

由于UDP是不可靠的、无连接的服务并且传输效率高，所以UDP应用的特点就是需要实时数据，可以允许丢包。所以QQ、视频软件、TFTP 简单文件传输协议(短信)等都是UDP应用。