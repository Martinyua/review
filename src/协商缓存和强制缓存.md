## 协商缓存和强制缓存

#### 协商缓存和强制缓存

* **强缓存**：浏览器不会像服务器发送任何请求，直接从本地缓存中读取文件并返回Status Code: 200 OK
* **协商缓存:** 如果没有命中强缓存，浏览器一定会发送一个请求到服务器，通过**last-modified**和**etag**验证资源是否命中协商缓存，如果命中，则**返回304状态码**并带上新的response header，但是不会返回这个资源的数据，然后通知浏览器从缓存中读取资源；
* 如果前面两者都没有命中，直接从服务器加载资源
* 异同：
  * 相同点：如果命中，都是从客户端缓存中加载资源，而不是从服务器加载资源数据；
  * 不同点：强缓存不发请求到服务器，协商缓存会发请求到服务器。

#### 相关字段

* **强缓存**通过**Expires**和Cache-**Control**两种响应头实现
  * **Expires**：表示资源过期时间的header，它描述的是一个绝对时间，**由服务器返回**。Expires 受限于本地时间，如果修改了本地时间，可能会造成缓存失效
  * **Cache-Control**：表示的是相对时间，优先级高于 Expires 
    * no-store:所有内容都不缓存
    * no-cache：缓存，但是浏览器使用缓存前，都会请求服务器判断缓存是否为最新
    * max-age = x：用来设置资源可以被缓存多长时间，单位为秒；
    * s-maxage = x:和max-age是一样的，不过它只针对代理服务器缓存(CDN)而言
    * private：只能针对个人用户，而不能被代理服务器缓存；
    * public:客户端和代理服务器（CDN）都可以缓存
* **协商缓存**通过**Last-Modifed/If-Modified-Since**和**Etag/If-None-Match**
  * **ETagTag**是**资源的唯一标识**，他的值是默认是对文件的索引节，大小和最后修改时间进行Hash后得到的。
  * 当资源过期时，浏览器发现响应头里有Etag,则再次像服务器请求时带上请求头**if-none-match**(**值是Etag的值**)。服务器收到请求进行比对，决定返回200或304
  * **Last-Modified**：浏览器向服务器发送资源最后的**修改时间**
  * **If-Modified-Since**：当浏览器判断Cache-Control标识的max-age过期，发现响应头具有Last-Modified声明，则再次向服务器请求时带上头if-modified-since。服务器收到请求后发现有if-modified-since则与被请求资源的最后修改时间进行对比，如果修改时间变化，则返回新的资源。如果修改时间没有变化，则返回304读取本地缓存

#### 参考

* [http面试必会的：强制缓存和协商缓存](https://juejin.im/post/5ccfccaff265da03ab233bf5#heading-4)

* [缓存（二）——浏览器缓存机制：强缓存、协商缓存](<https://github.com/amandakelake/blog/issues/41>)